<main>
<?= $nav?>
    <form class="form form--add-lot container <?php if (!isset($errors)): ?>form--invalid<?php endif; ?> "
        enctype="multipart/form-data" action="add.php" method="post"> <!-- form--invalid -->
        <h2>Добавление лота</h2>
        <div class="form__container-two">
            <div class="form__item <?php if (isset($errors['lot-name'])): ?> form__item--invalid <?php endif; ?>">
                <!-- form__item--invalid -->
                <label for="lot-name">Наименование <sup>*</sup></label>
                <input id="lot-name" type="text" value="<?= getPostVal('lot-name'); ?>" name="lot-name" 
                placeholder="Введите наименование лота">
                <span class="form__error">
                    <?= $errors['lot-name'] ?>
                </span>
            </div>
            <div class="form__item  <?php if (isset($errors['category'])): ?> form__item--invalid <?php endif; ?>">
                <label for="category">Категория <sup>*</sup></label>
                <select id="category" name="category">
                <option hidden value=""></option>
                    <?php foreach ($categories as $item): ?>
                        <option <?=$item['Id'] === getPostVal('category')? "selected" : "" ?> value="<?= $item['Id'] ?>">
                            <?= htmlspecialchars($item['NameCategory']) ?>
                        </option>
                    <?php endforeach; ?>
                </select>
                <span class="form__error"><?= $errors['category'] ?></span>
            </div>
        </div>
        <div
            class="form__item <?php if (isset($errors['message'])): ?> form__item--invalid <?php endif; ?> form__item--wide">
            <label for="message">Описание <sup>*</sup></label>
            <textarea id="message" name="message"
                placeholder="Напишите описание лота"><?= getPostVal('message'); ?></textarea>
            <span class="form__error">
                <?= $errors['message'] ?>
            </span>
        </div>
        <div
            class="form__item form__item--file <?php if (isset($errors['image'])): ?> form__item--invalid <?php endif; ?> ">
            <label>Изображение <sup>*</sup></label>
            <div class="form__input-file">
                <input class="visually-hidden" name="image" type="file" id="lot-img" value="">
                <label for="lot-img">
                    Добавить
                </label>
                <span class="form__error">
                    <?= $errors['image'] ?>
                </span>
            </div>
        </div>
        <div class="form__container-three">
            <div
                class="form__item <?php if (isset($errors['lot-rate'])): ?> form__item--invalid <?php endif; ?> form__item--small">
                <label for="lot-rate">Начальная цена <sup>*</sup></label>
                <input id="lot-rate" value="<?= getPostVal('lot-rate'); ?>" type="text" name="lot-rate" placeholder="0">
                <span class="form__error">
                    <?= $errors['lot-rate'] ?>
                </span>
            </div>
            <div
                class="form__item  form__item--small <?php if (isset($errors['lot-step'])): ?>form__item--invalid<?php endif; ?>">
                <label for="lot-step">Шаг ставки <sup>*</sup></label>
                <input id="lot-step" value="<?= getPostVal('lot-step'); ?>" type="text" name="lot-step" placeholder="0">
                <span class="form__error">
                    <?= $errors['lot-step'] ?>
                </span>
            </div>
            <div class="form__item <?php if (isset($errors['lot-date'])): ?> form__item--invalid <?php endif; ?>">
                <label for="lot-date">Дата окончания торгов <sup>*</sup></label>
                <input class="form__input-date" id="lot-date" type="text"
                    name="lot-date" placeholder="Введите дату в формате ГГГГ-ММ-ДД" value="<?= getPostVal('lot-date');?>" >
                <span class="form__error">
                    <?= $errors['lot-date'] ?>
                </span>
            </div>
        </div>
        <span class="form__error form__error--bottom">Пожалуйста, исправьте ошибки в форме.</span>
        <button type="submit" class="button">Добавить лот</button>
    </form>
</main>




function get_lot_by_id(mysqli $con, int $lot_id): array|null
{
    $sql = "SELECT 
    Lot.Id, 
    `NameLot`,
       `Detail`,
       `DateCreate`,
       `StartPrise`,
       `Image`,
       Category.NameCategory,
       `DateEnd`,
       `StepBet`
FROM `Lot`
         INNER JOIN Category ON Lot.CategoryId = Category.Id
WHERE Lot.Id = ?";
    $stmt = mysqli_prepare($con, $sql);
    mysqli_stmt_bind_param($stmt, 'i', $lot_id);
    mysqli_stmt_execute($stmt);
    $select_res = mysqli_stmt_get_result($stmt);
    $rows = mysqli_fetch_assoc($select_res);
    if (mysqli_num_rows($select_res) === 0) {
        http_response_code(404);
    }
    return $rows;
}

function add_lot(
    string $NameLot,
    string $Detail,
    string $Image,
    int $StartPrise,
    string $DateEnd,
    int $StepBet,
    int $CategoryId,
    mysqli $con
): int {
    $AuthorId = 2;
    $sql = "INSERT INTO Lot( NameLot, Detail, Image, StartPrise, DateEnd, StepBet, AuthorId, CategoryId)
            VALUES ( ?,?,?,?,?,?,?,?)";
    $stmt = mysqli_prepare($con, $sql);
    mysqli_stmt_bind_param($stmt, 'sssisiii', $NameLot, $Detail, $Image, $StartPrise, $DateEnd, $StepBet, $AuthorId, $CategoryId);
    mysqli_stmt_execute($stmt);
    return $con->insert_id;
}


function pr ($val){
    $bt   = debug_backtrace();
    $file = file($bt[0]['file']);
    $src  = $file[$bt[0]['line']-1];
    $pat = '#(.*)'.__FUNCTION__.' *?\( *?(.*) *?\)(.*)#i';
    $var  = preg_replace ($pat, '$2', $src);
    echo '<script>console.log("'.trim($var).'='. 
     addslashes(json_encode($val,JSON_UNESCAPED_UNICODE)) .'")</script>'."\n";
}



const MAX_NAME_LENGHT = 75;
const MAX_DETAIL_LENGHT = 500;

// if($_SERVER['REQUEST_METHOD'] == 'POST')

$categories = get_categories($con);
$nav = include_template('categories.php', ['categories' => $categories]);


function getPostVal($name)
{
    return $_POST[$name] ?? "";
}



$errors = [];
$required_fields = ['lot-name', 'category', 'message', 'lot-rate', 'lot-step', 'lot-date'];

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    foreach ($required_fields as $field) {
        if (empty($_POST[$field])) {
            $errors[$field] = 'Поле не заполнено';
        }
    }

    if(!isset($errors['category'])){
        $category_id = [];
        foreach($categories as $catigory){
            array_push($category_id, $catigory['Id']);
        }

    }

    if (!isset($errors['lot-date'])) {
        if (!is_date_valid($_POST['lot-date']) || (time() >= strtotime($_POST['lot-date']))) {
            $errors['lot-date'] = 'Дата не должна быть пустой или меньше текущей';
        }
    }

    if (!isset($errors['lot-rate'])) {
        if (!filter_var($_POST['lot-rate'], FILTER_VALIDATE_INT)) {
            $errors['lot-rate'] = 'Цена должна быть натуральныим числом';
        } elseif ($_POST['lot-rate'] < 0) {
            $errors['lot-rate'] = 'Цена должна быть больше 0';
        }
    }

    if (!isset($errors['lot-step'])) {
        if (!filter_var($_POST['lot-step'], FILTER_VALIDATE_INT)){
            $errors['lot-step'] = 'Ставка должна быть натуральныим числом';
        } elseif ($_POST['lot-step'] < 1) {
            $errors['lot-step'] = 'Стаквка должна быть больше 0';
        }
    }


    if (!isset($errors['lot-name'])) {
        $len = strlen($_POST['lot-name']);
        if ($len > MAX_NAME_LENGHT) {
            $errors['lot-name'] = 'Значение должно быть меньше ' . MAX_NAME_LENGHT . ' символов';
        }
    }

    if (!isset($errors['message'])) {
        $len = strlen($_POST['message']);
        if ($len > MAX_DETAIL_LENGHT) {
            $errors['message'] = 'Значение должно быть меньше ' . MAX_DETAIL_LENGHT . ' символов';
        }
    }

    $temp = time();

    //Обработка изображения
    if ($_FILES) {
        if ($_FILES['image']['tmp_name'] !== "") {
            if (
                (mime_content_type($_FILES['image']['tmp_name']) == "image/png") || (mime_content_type($_FILES['image']['tmp_name']) == "image/jpeg")
                || (mime_content_type($_FILES['image']['tmp_name']) == "image/jpg")
            ) {
                $file_name = $_FILES['image']['name'];
                $file_path = __DIR__ . '/uploads/';
                $file_url = '/uploads/' . $temp . $file_name;
                move_uploaded_file($_FILES['image']['tmp_name'], $file_path . $temp . $file_name);
            } else {
                $errors['image'] = "Картинка должна быть в формате *.png, *.jpeg или *.jpg";
            }
        } else {
            $errors['image'] = "Добавте изображение";
        }
    }
    if (empty($errors)) {


        $addLot = add_lot(
            $_POST['lot-name'],
            $_POST['message'],
            '/uploads/' . $temp . $_FILES['image']['name'],
            $_POST['lot-rate'],
            $_POST['lot-date'],
            $_POST['lot-step'],
            $_POST['category'],
            $con
        );

        $lot = get_lot_by_id(
            $con,
            $addLot
        );

        foreach ($required_fields as $field) {
            [$field] = "";
        }



        if (http_response_code() === 404) {
            $page_content = include_template('404.php', ['nav' => $nav]);
        } else {
            $page_content = header('Location: /lot.php?Id=' . $addLot);
        }
        $layout = include_template('layout.php', [
            'title' => 'Главная',
            'is_auth' => $is_auth,
            'user_name' => $user_name,
            'nav' => $nav,
            'contetnt' => $page_content
        ]);

        print($layout);

    } else {
        $page_content = include_template('add-lot.php', ['errors' => $errors, 'nav' => $nav, 'categories' => $categories]);
        $layout = include_template('layout.php', [
            'title' => 'Главная',
            'is_auth' => $is_auth,
            'user_name' => $user_name,
            'nav' => $nav,
            'contetnt' => $page_content
        ]);
        print($layout);
    }
}else{


$page_content = include_template('add-lot.php', ['errors' => $errors, 'nav' => $nav, 'categories' => $categories]);
$layout = include_template('layout.php', [
    'title' => 'Главная',
    'is_auth' => $is_auth,
    'user_name' => $user_name,
    'nav' => $nav,
    'contetnt' => $page_content
]);
print($layout);
}






<?php
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        // Обработка данных здесь

        // Подключите файл с вашими классами
        require 'your_classes_file.php';

        // Создайте объект и вызовите метод actionCreate
        $dsn = "mysql:host=localhost;dbname=akhfvmxt_m4;charset=UTF8";
        $pdo = new PDO($dsn, 'akhfvmx', 'Tp83F6');
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

        $title = $_POST['title'];
        // Получите остальные значения из $_POST

        // Создание экземпляра класса в зависимости от типа продукта (CD или книга)
        if (!empty($playLength)) {
            $product = new CDProduct($title, $firstName, $mainName, $price, $playLength);
        } elseif (!empty($numPages)) {
            $product = new BookProduct($title, $firstName, $mainName, $price, $numPages);
        }

        // Вызов метода для добавления в базу данных
        if (isset($product)) {
            $product->actionCreate($pdo);
            echo "Запись успешно добавлена в базу данных.";
        }
    }
    ?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Добавление записи в базу данных</title>
</head>
<body>
    <h1>Добавление записи в базу данных</h1>

    <!-- Форма для добавления записи -->
    <form method="post" action="">
        <label for="title">Название продукта:</label>
        <input type="text" name="title" id="title" required>
        <br>

        <label for="firstName">Имя производителя:</label>
        <input type="text" name="firstName" id="firstName">
        <br>

        <label for "mainName">Фамилия производителя:</label>
        <input type="text" name="mainName" id="mainName">
        <br>

        <label for="price">Цена:</label>
        <input type="number" name="price" id="price" step="0.01" required>
        <br>

        <label for="playLength">Длительность воспроизведения (только для CD):</label>
        <input type="number" name="playLength" id="playLength">
        <br>

        <label for="numPages">Количество страниц (только для книги):</label>
        <input type="number" name="numPages" id="numPages">
        <br>

        <input type="submit" value="Добавить запись">
    </form>

    <?php
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        // Получение и обработка данных происходит здесь
        // Остальной PHP код, как описано выше
    }
    ?>
</body>
</html>






<!-- Форма для добавления записи -->
<form method="post" action="">
    <label for="title">Название продукта:</label>
    <input type="text" name="title" id="title" required>
    <br>

    <label for="firstName">Имя производителя:</label>
    <input type="text" name="firstName" id="firstName">
    <br>

    <label for="mainName">Фамилия производителя:</label>
    <input type="text" name="mainName" id="mainName">
    <br>

    <label for="price">Цена:</label>
    <input type="number" name="price" id="price" step="0.01" required>
    <br>

    <label for="playLength">Длительность воспроизведения (только для CD):</label>
    <input type="number" name="playLength" id="playLength">
    <br>

    <label for="numPages">Количество страниц (только для книги):</label>
    <input type="number" name="numPages" id="numPages">
    <br>

    <input type="submit" value="Добавить запись">
</form>

<?php
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Получаем данные из формы
    $title = $_POST['title'];
    $firstName = $_POST['firstName'];
    $mainName = $_POST['mainName'];
    $price = (float)$_POST['price'];
    $playLength = (float)$_POST['playLength'];
    $numPages = (int)$_POST['numPages'];

    // Создаем экземпляр класса в зависимости от типа продукта (CD или книга)
    if (!empty($playLength)) {
        $product = new CDProduct($title, $firstName, $mainName, $price, $playLength);
    } elseif (!empty($numPages)) {
        $product = new BookProduct($title, $firstName, $mainName, $price, $numPages);
    } else {
        // Дополнительная логика, если не удалось определить тип продукта
        echo "Не удалось определить тип продукта.";
    }

    // Вызываем метод для добавления в базу данных
    if (isset($product)) {
        $product->actionCreate($pdo);
        echo "Запись успешно добавлена в базу данных.";
    }
}
?>
